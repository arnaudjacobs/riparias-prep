---
title: "Riparias - Baseline"
author: "Sander Devisscher"
date: "`r Sys.time()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r libraries, include=FALSE}
library(googlesheets4)
library(googledrive)
library(rgdal)
library(rgeos)
library(sp)
library(raster)
library(leaflet)
library(tidyverse)
library(knitr)

crs_wgs <- CRS("+proj=longlat +datum=WGS84 +no_defs")
```

```{r get perimeter shape, include = FALSE}
perimeter_shape <- readOGR("./data/spatial/perimeter", "Riparias_Official_StudyArea", stringsAsFactors = FALSE)

perimeter_shape <- spTransform(perimeter_shape, crs_wgs)

bbox <- as.data.frame(perimeter_shape@bbox)
```

```{r test perimeter, eval = FALSE}
leaflet(perimeter_shape) %>% 
  addTiles() %>% 
  addPolylines()
```

```{r get pointdata, include = FALSE}
pointdata <- readOGR("./data/spatial/baseline", "t2_ALL_points_Batch2_1_3", stringsAsFactors = FALSE)
```

```{r test points, eval = FALSE}
leaflet(pointdata) %>% 
  addTiles() %>% 
  addCircleMarkers()
```

https://docs.google.com/spreadsheets/d/15f17hXE9ZyUxEe2xA0seKs0CSibgYJdkaWcnmVoI1yY/edit#gid=0

```{r get nameserver}
bo_email <- Sys.getenv("bo_email")
gs4_auth(email = bo_email)

nameserver <- read_sheet("15f17hXE9ZyUxEe2xA0seKs0CSibgYJdkaWcnmVoI1yY")

nameserver$taxonKey <- as.double(nameserver$taxonKey)
```

```{r intersect with perimeter, include = FALSE}
points_in_perimeter <- raster::intersect(pointdata, perimeter_shape)

points_in_perimeter@data <- points_in_perimeter@data %>% 
  left_join(nameserver, by = c("accptTK" = "taxonKey")) %>% 
  mutate(popup = paste0("Species: ", vernacular_name_en, " <em>", scientific_name ,"</em><br>",
                        "Year: ", year, "<br>",
                        "Dataset: <a href=", datstID, ">", datstID, "</a><br>",
                        "Source: ", Source, "<br>",
                        recrdrl, "GBIF record</a>"))
  
NoEngName <- points_in_perimeter@data %>% 
  filter(is.na(vernacular_name_en))

table(NoEngName$accptTK)

table(points_in_perimeter$vernacular_name_en)

writeOGR(points_in_perimeter, dsn = "./data/spatial/baseline/points_in_perimeter.geojson", layer = "points_in_perimeter", driver = "GeoJSON", overwrite_layer = TRUE)
```

```{r export as csv}
write_delim(points_in_perimeter@data, 
            "./data/output/points_in_perimeter.csv", 
            ";")
```

