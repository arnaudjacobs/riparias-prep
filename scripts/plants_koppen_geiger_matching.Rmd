
This script downloads all occurences of a list plants commonly found in plantshops 
in Belgium from gbif. Species who do not have occurences in Belgium yet are 
linked to a climate zone defined by Koppen Geiger. Finally a specieslist 
consisting of species that have at least x occurrences, which represent at least
y% of the total number of species occurrences, in the climate zones of Belgium, 
is created. 
Climate matching is done for 2 scenarios. One representing the current climate
and one the future climate according to KÃ¶ppen Geiger. 

```{r setup}
library(googlesheets4)
library(dplyr)
library(rgbif)
library(sp)

library(devtools)
install_github("trias-project/trias", ref = "73_climate_matching_function")

library(trias)
```

```{r FUN check}
check <- function(x){
  tryCatch(if(class(x) == 'logical') 1 else 1, error=function(e) 0)
} 
```

```{r FUN get_cred}
get_cred <- function(x){
  library(svDialogs)
  
  cred <- Sys.getenv(x)
  
  if(cred == ""){
    input <- dlgInput(paste0("What is your ", x, "?"))
    cred <- input$res
    Sys.setenv(x = cred)
  }
  return(cred)
}
```

```{r read species list}
gsheet_email <- get_cred("gsheet_email")

gs4_auth(email = gsheet_email)

White_list <- read_sheet("18HNS3HCNbhvTWIn-6iJHQXsPQbfBtOnNZHi7vZRyYDk", 
                         sheet = 1,
                         col_types = "c")

White_list_redux <- White_list %>%
  filter(!is.na(taxonKey)) %>% 
  mutate(Key = as.integer(taxonKey))

table(White_list_redux$`Taxon category`)
taxonkeys <- as.integer(unique(White_list_redux$taxonKey))
```

```{r run climate matching function}
zipfile <- "./0336409-200613084148143.zip"

target <- 75
cuts <- ceiling(length(taxonkeys)/target)

gc(reset = TRUE)
if(memory.limit() <= 300 * length(taxonkeys)){
  memory.limit(size = 300 * length(taxonkeys))
}

for(i in 1:cuts){
  gc(reset = TRUE)
  if(i == 1){
    start <- 1
    end <- target
  }else{
    start <- (i-1)*target
    end <- i*target
    if(end > length(taxonkeys)){
      end <- length(taxonkeys)
    }
  }
  taxonkeys_sub <- taxonkeys[start:end]
  output <- climate_match(region = "Belgium",
                        taxonkey = taxonkeys_sub,
                        BasisOfRecord = c("HUMAN_OBSERVATION", "PRESERVED_SPECIMEN", "UNKNOWN"),
                        perc_climate = 0.2,
                        n_totaal = 90,
                        zipfile = zipfile,
                        maps = FALSE)
  
  assign(paste0("output_", i), output)
}


```

